{"version":3,"sources":["index.js"],"names":["ENCRYPTION_KEY","process","env","IV_LENGTH","encryptMessage","message","iv","crypto","randomBytes","cipher","createCipheriv","Buffer","from","encrypted","update","toString","decryptMessage","encryptedMessage","split","ivHex","encryptedText","decipher","createDecipheriv","decrypted","dotenv","config","path","app","server","use","origin","methods","allowedHeaders","credentials","express","json","limit","extended","urlencoded","join","get","req","res","send","bodyParser","userroutes","videoroutes","commentroutes","chatRoutes","httpServer","PORT","io","Server","cors","optionSuccessStatus","on","socket","console","log","id","roomId","userId","newMessage","Chat","save","decryptedMessage","to","emit","post","body","src","tgt","command","error","stdout","status","JSON","parse","DB_URL","mongoose","connect","useNewUrlParser","useUnifiedTopology","then","listen"],"mappings":"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","sourcesContent":["// server/index.js\r\n\r\nimport express from \"express\";\r\nimport mongoose from \"mongoose\";\r\nimport dotenv from \"dotenv\";\r\nimport cors from \"cors\";\r\nimport bodyParser from \"body-parser\";\r\nimport videoroutes from \"./Routes/video.js\";\r\nimport userroutes from \"./Routes/User.js\";\r\nimport chatRoutes from \"./Routes/chat.js\";\r\nimport path from \"path\";\r\nimport commentroutes from \"./Routes/comment.js\";\r\nimport Chat from \"./Models/chat.js\"; // Import the chat model\r\nimport crypto from \"crypto\"; // Encryption library\r\nimport { createServer } from \"http\"; // To create an HTTP server\r\nimport socketServer from \"./socket.js\";\r\nimport { Server } from \"socket.io\"; // Import socket.io\r\nimport { exec } from \"child_process\";\r\n\r\nconst ENCRYPTION_KEY =\r\n  process.env.ENCRYPTION_KEY || \"abcdefghijklmnopqrstuvwxzy012345\"; // Must be 32 characters for aes-256\r\nconst IV_LENGTH = 16; // For AES, the IV length should be 16 bytes\r\n\r\n// Encrypt the message\r\nconst encryptMessage = (message) => {\r\n  const iv = crypto.randomBytes(IV_LENGTH);\r\n  const cipher = crypto.createCipheriv(\r\n    \"aes-256-ctr\",\r\n    Buffer.from(ENCRYPTION_KEY),\r\n    iv\r\n  );\r\n  let encrypted = cipher.update(message, \"utf8\", \"hex\");\r\n  encrypted += cipher.final(\"hex\");\r\n  return iv.toString(\"hex\") + \":\" + encrypted;\r\n};\r\n\r\n// Decrypt the message\r\nconst decryptMessage = (encryptedMessage) => {\r\n  const [ivHex, encryptedText] = encryptedMessage.split(\":\"); // Separate the IV from the message\r\n  const iv = Buffer.from(ivHex, \"hex\");\r\n  const decipher = crypto.createDecipheriv(\r\n    \"aes-256-ctr\",\r\n    Buffer.from(ENCRYPTION_KEY),\r\n    iv\r\n  );\r\n  let decrypted = decipher.update(encryptedText, \"hex\", \"utf8\");\r\n  decrypted += decipher.final(\"utf8\");\r\n  return decrypted;\r\n};\r\n\r\n// Environment Variables\r\ndotenv.config({ path: \"./.env\" });\r\n\r\n// Express App Initialization\r\nconst app = express();\r\nconst server = createServer(app);\r\nsocketServer(server);\r\n\r\napp.use(cors({\r\n    origin: [\"https://chirags-youtube-clone.netlify.app\", \"http://localhost:3000\"], // Allow requests from this origin\r\n    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],\r\n    allowedHeaders: ['Content-Type', 'Authorization'],// Specify allowed HTTP methods\r\n    credentials: true // Include credentials if needed\r\n}));\r\napp.use(express.json({ limit: \"30mb\", extended: true }));\r\napp.use(express.urlencoded({ limit: \"30mb\", extended: true }));\r\napp.use(\"/uploads\", express.static(path.join(\"uploads\")));\r\n\r\napp.get(\"/\", (req, res) => {\r\n  res.send(\"Your tube is working\");\r\n});\r\n\r\napp.use(bodyParser.json());\r\napp.use(\"/user\", userroutes);\r\napp.use(\"/video\", videoroutes);\r\napp.use(\"/comment\", commentroutes);\r\napp.use(\"/chat\", chatRoutes);\r\n\r\n// Initialize HTTP Server\r\nconst httpServer = createServer(app);\r\nconst PORT = process.env.PORT;\r\n\r\n// Initialize Socket.io\r\nconst io = new Server(httpServer, {\r\n  cors: {\r\n    origin: [\"https://chirags-youtube-clone.netlify.app\", \"http://localhost:3000\"],// Your frontend's URL\r\n    // origin: [\"http://localhost:3000\"],// Your frontend's URL\r\n    methods: [\"POST\", \"GET\", \"PATCH\"],\r\n    credentials: true,\r\n    optionSuccessStatus: 200,// Set up the correct CORS for frontend access\r\n  },\r\n});\r\n\r\n// Socket.io chat logic\r\nio.on(\"connection\", (socket) => {\r\n  console.log(\"a user connected:\", socket.id);\r\n\r\n  socket.on(\"joinRoom\", ({ roomId, userId }) => {\r\n    socket.join(roomId);\r\n    console.log(`${userId} joined room ${roomId}`);\r\n  });\r\n\r\n  socket.on(\"chatMessage\", async ({ roomId, userId, message }) => {\r\n    console.log(\r\n      `Message received from ${userId} in room ${roomId}: ${message}`\r\n    );\r\n\r\n    const encryptedMessage = encryptMessage(message);\r\n    const newMessage = new Chat({ roomId, userId, message: encryptedMessage });\r\n\r\n    await newMessage.save(); // Save to database\r\n\r\n    // Decrypt message before emitting to clients\r\n    const decryptedMessage = decryptMessage(encryptedMessage);\r\n\r\n    // Emit the decrypted message to the room\r\n    io.to(roomId).emit(\"message\", { userId, message: decryptedMessage });\r\n    console.log(`Message broadcasted to room: ${roomId}`);\r\n  });\r\n\r\n  socket.on(\"disconnect\", () => {\r\n    console.log(\"user disconnected\");\r\n  });\r\n});\r\n\r\n// Proxy translation request to OpenNMT server\r\napp.post(\"/translate\", async (req, res) => {\r\n  const { src, tgt } = req.body;\r\n  // const command = `curl -X POST http://localhost:5000/translate -H \"Content-Type: application/json\" -d '{\"src\": \"${src}\", \"tgt\": \"${tgt}\"}'`;\r\n  const command = `curl -X POST https://youtubeclone-server.vercel.app/translate -H \"Content-Type: application/json\" -d '{\"src\": \"${src}\", \"tgt\": \"${tgt}\"}'`;\r\n\r\n  exec(command, (error, stdout) => {\r\n    if (error) {\r\n      res.status(500).json({ error: \"Translation failed.\" });\r\n    } else {\r\n      res.json(JSON.parse(stdout));\r\n    }\r\n  });\r\n});\r\n\r\napp.post(\"/api/send-email-otp\", async (req, res) => {\r\n  // your email OTP sending logic\r\n});\r\n\r\napp.post(\"/api/send-mobile-otp\", async (req, res) => {\r\n  // your mobile OTP sending logic\r\n});\r\n\r\n// MongoDB Connection and Server Listener\r\nconst DB_URL = process.env.DB_URL;\r\nmongoose\r\n  .connect(DB_URL, {\r\n    useNewUrlParser: true,\r\n    useUnifiedTopology: true,\r\n    // serverSelectionTimeoutMS: 5000, // Timeout if the database is unreachable\r\n  })\r\n  .then(() => {\r\n    console.log(\"Mongodb Database connected\");\r\n  })\r\n  .catch((error) => {\r\n    console.log(error);\r\n  });\r\n\r\n// Start both HTTP and Socket.io servers\r\nhttpServer.listen(PORT, () => {\r\n  console.log(`Server running on Port ${PORT}`);\r\n});\r\n"],"file":"index.dev.js"}